// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums (Matching your Solidity Enums) ---
enum TicketState {
  IDLE
  STAKED
  COLLATERALIZED
  LISTED
}

// --- Core Entities ---

model User {
  id            String   @id @default(uuid())
  walletAddress String   @unique // The "Global ID" (e.g., 0xAlice...)
  email         String?  @unique // For notifications (linked via Privy)
  createdAt     DateTime @default(now())

  // Relationships
  tickets   Ticket[]  // All tickets this user currently owns (on-chain owner)
  loans     Loan[]    // Active loans this user has taken
  stakes    Stake[]   // Active stakes this user has made
  listings  Listing[] // Active marketplace listings
}

model Ticket {
  id        String   @id @default(uuid())
  tokenId   Int      @unique // The on-chain Token ID (1, 2, 3...)
  
  // Flight Data (Cached from Metadata/Mock API)
  departureTime Int
  route         String
  basePrice     Decimal  @db.Decimal(18, 2) 
  
  // Dynamic On-Chain State
  state     TicketState @default(IDLE)
  
  // Valuation (Updated by Oracle Events)
  currentPrice Decimal  @db.Decimal(18, 2)
  lastPriceUpdate DateTime @default(now())

  // Relationships
  ownerAddress String
  owner        User   @relation(fields: [ownerAddress], references: [walletAddress])
  
  // A ticket can be ONE of these things at a time:
  activeLoan    Loan?
  activeStake   Stake?
  activeListing Listing?

  // History
  priceHistory  PriceUpdate[]
}

// --- Protocol Entities (The "Mirrors") ---

model Loan {
  id        String   @id @default(uuid())
  userAddress String
  user        User     @relation(fields: [userAddress], references: [walletAddress])
  
  // The collateral is a specific Ticket
  ticketId  Int      @unique
  ticket    Ticket   @relation(fields: [ticketId], references: [tokenId])

  // Loan Details
  debtAmount    Decimal  @db.Decimal(18, 6) // USDC debt
  healthFactor  Decimal  @db.Decimal(18, 18) // e.g. 1.5
  updatedAt     DateTime @updatedAt
}

model Stake {
  id        String   @id @default(uuid())
  userAddress String
  user        User     @relation(fields: [userAddress], references: [walletAddress])

  ticketId  Int      @unique
  ticket    Ticket   @relation(fields: [ticketId], references: [tokenId])

  stakedAt  DateTime @default(now())
}

model Listing {
  id        String   @id @default(uuid())
  sellerAddress String
  seller        User     @relation(fields: [sellerAddress], references: [walletAddress])

  ticketId  Int      @unique
  ticket    Ticket   @relation(fields: [ticketId], references: [tokenId])

  price     Decimal  @db.Decimal(18, 6) // USDC Price
  listedAt  DateTime @default(now())
}

// --- History Tables (For Charts) ---

model PriceUpdate {
  id        String   @id @default(uuid())
  ticketId  Int
  ticket    Ticket   @relation(fields: [ticketId], references: [tokenId])
  
  price     Decimal  @db.Decimal(18, 2)
  timestamp DateTime @default(now())
}